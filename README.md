DMITTREY DBMS

# Типы данных

## JsonValue struct

|        |
| ------ |
| Object |
| String |
| Type   |


# Логическая организация

Система имеет **три** уровня абстракции:

| Уровень            | Назначение                                    |
| ------------------ | --------------------------------------------- |
| DB API             | Работа с БД на логическом уровне              |
| DB FILE IO         | Работа с файлом на физическом уровне          |
| DB FILE SECTION IO | Работа с секцими в файле на физическом уровне |

# Физическая организация 

## Репрезентация секций в файле

|         |
| ------- |
| Extents |
| Extents |
| Extents |
| Extents |
| Extents |

Есть один тип секции расположенный в **рандомном** порядке, секции хранят json записи

---

## Обобщенная организация секций

|             |            |         |               |                  |
| ----------- | ---------- | ------- | ------------- | ---------------- |
| Header      |            |         |               |                  |
| Content     | free_space | next    | last_item_ptr | first_record_ptr |
| Size(bytes) | 8          | 8       | 8             | 8                |
| Body        |            |         |               |                  |
| Content     | item1      | item2   | item3         |                  |
| Size(bytes) | 8          | 8       | 8             |                  |
| Content     |            | record3 | record2       | record1          |
| Size(bytes) |            | unknwn  | unknwn        | unknwn           |

Секция состоит из **Header с служебной информацией** для логической организации и **Body секции с записями**

Тело устроено так, что после Header идёт массив указателей на записи(items), размер которых равен 8 байт. 

C конца секции начинаются записи неизвестного размера(records).

- item указывает **на начало записи**
- Адрес record рассчитывается как **отступ от начала секции**
---

## Организация секции Header

| Header      |            |      |               |                  |
| ----------- | ---------- | ---- | ------------- | ---------------- |
| Content     | free_space | next | last_item_ptr | first_record_ptr |
| Size(bytes) | 8          | 8    | 8             | 8                |

**Назначение полей:**

- *free_space* - Оставшееся место в секции, которое можно заполнить
- *next* - Физический адрес следующей секции(оступ от **начала файла**)
- *last_item_ptr* - Физический адрес первого свободного байта после всех items(отступ от **начала секции**)
- *first_record_ptr* - Физический адрес первого занятого байта перед всеми records(отступ от **начала секции**)

---

## Организация тела секции Extents

| Extents body |                |               |               |        |      |
| ------------ | -------------- | ------------- | ------------- | ------ | ---- |
| Content      | attr_cnt       | type          | val_ptr       | parent | next |
| Size(bytes)  | 8              | 8             | 8             | 8      | 8    |
| Content      | attr1_key_size | attr1_key_ptr | attr1_val_ptr | ...    |      |
| Size(bytes)  | 8              | 8             | 8             |        |      |


**Item** состоит из элементов:

- *attr_cnt* - Кол-во атрибутов
- *type* - Тип
- *val_ptr* - Физический адрес содержимого(оступ от **начала секции**)
- *parent* - Физический адрес содержимого родительской ноды(оступ от **начала файла**)
- *next* - Физический адрес содержимого соседней ноды(оступ от **начала файла**)
- *attr_key_size* - Длина имени атрибута, **может быть несколько**
- *attr_key_ptr* - Физический адрес имени атрибута(оступ от **начала секции**)
- *attr_val_ptr* - Физический адрес значения атрибута(оступ от **начала файла**)
  
**Record** состоит из элементов:

- *attr_key* - Название атрибута
- *val* - Содержимое ноды

