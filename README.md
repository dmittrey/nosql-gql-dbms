DMITTREY DBMS

# Типы данных

## Node struct

|            |
| ---------- |
| document   |
| parent     |
| name       |
| type       |
| attributes |
| children   |
| text       |

## Documents struct

|      |
|------|
| name |
| root |



# Логическая организация

Система имеет **три** уровня абстракции:

| Уровень            | Назначение                                    |
| ------------------ | --------------------------------------------- |
| DB API             | Работа с БД на логическом уровне              |
| DB FILE IO         | Работа с файлом на физическом уровне          |
| DB FILE SECTION IO | Работа с секцими в файле на физическом уровне |

# Физическая организация 

## Репрезентация секций в файле

|           |
| --------- |
| Documents |
| Extent    |
| Extent    |
| Documents |
| Extent    |

Есть две секции расположенные в **рандомном** порядке, которые хранят информацию либо о документах либо о нодах

---

## Обобщенная организация секций

|             |            |         |               |                  |
| ----------- | ---------- | ------- | ------------- | ---------------- |
| Header      |            |         |               |                  |
| Content     | free_space | next    | last_item_ptr | first_record_ptr |
| Size(bytes) | 8          | 8       | 8             | 8                |
| Body        |            |         |               |                  |
| Content     | item1      | item2   | item3         |                  |
| Size(bytes) | 8          | 8       | 8             |                  |
| Content     |            | record3 | record2       | record1          |
| Size(bytes) |            | unknwn  | unknwn        | unknwn           |

Секция состоит из **Header с служебной информацией** для логической организации и **Body секции с записями**

Тело устроено так, что после Header идёт массив указателей на записи(items), размер которых равен 8 байт. 

C конца секции начинаются записи неизвестного размера(records).

- item указывает **на начало записи**
- Адрес record рассчитывается как **отступ от начала секции**
---

## Организация секции Header

| Header      |            |      |               |                  |
| ----------- | ---------- | ---- | ------------- | ---------------- |
| Content     | free_space | next | last_item_ptr | first_record_ptr |
| Size(bytes) | 8          | 8    | 8             | 8                |

**Назначение полей:**

- *free_space* - Оставшееся место в секции, которое можно заполнить
- *next* - Физический адрес следующей секции(оступ от **начала файла**)
- *last_item_ptr* - Физический адрес первого свободного байта после всех items(отступ от **начала секции**)
- *first_record_ptr* - Физический адрес последнего свободного байта перед всеми records(отступ от **начала секции**)

---

## Организация тела секции Documents

| Documents body |             |          |                 |        |
| -------------- | ----------- | -------- | --------------- | ------ |
| Content        | name_length | name_ptr | first_node_addr |        |
| Size(bytes)    | 8           | 8        | 8               |        |
| Content        |             |          |                 | name   |
| Size(bytes)    |             |          |                 | unknwn |

**Item** состоит из трех элементов:
- *name_length* - Длина названия документа
- *name_ptr* - Физический адрес названия документа(отступ от **начала секции**)
- *first_node_addr* - Физический адрес первой ноды документа(оступ от **начала файла**)

**Record** является нуль-термированной строкой являющейся названием документа

---

## Организация тела секции Section

| Nodes body  |               |               |          |             |            |            |                |                |     |
| ----------- | ------------- | ------------- | -------- | ----------- | ---------- | ---------- | -------------- | -------------- | --- |
| Content     | doc_addr      | parent_addr   | name_len | name_ptr    | type       | attr_count | attr1_name_len | attr1_name_ptr | ... |
| Size(bytes) | 8             | 8             | 8        | 8           | 1          | 8          | 8              | 8              |     |
| Content     | attr1_val_len | attr1_val_ptr | ...      | child_count | child1_ptr | ...        | text_len       | text_ptr       |     |
| Size(bytes) | 8             | 8             |          | 8           | 8          |            | 8              | 8              |     |


**Item** состоит из элементов:

- *doc_addr* - Физический адрес Документа(оступ от **начала файла**)
- *parent_addr* - Физический адрес родительской ноды(оступ от **начала файла**)
- *name_len* - Длина названия ноды
- *name_ptr* - Физический адрес на название ноды(оступ от **начала секции**)
- *type* - Тип ноды
- *attr_count* - Кол-во атрибутов
- *attr_name_len* - Длина имени атрибута, **может быть несколько**
- *attr_name_ptr* - Физический адрес имени атрибута(оступ от **начала секции**)
- *attr_val_len* - Длина значения атрибута, **может быть несколько**
- *attr_val_ptr* - Физический адрес значения атрибута(оступ от **начала секции**)
- *child_count* - Кол-во дочерних нод
- *child_ptr* - Указатель на дочернюю ноду
- *text_len* - Длина содержимого ноды
- *text_ptr* - Указатель на соедржимое ноды
  
**Record** состоит из элементов:

- *name* - Название ноды
- *attr_name* - Название атрибута
- *attr_val* - Занчение атрибута
- *text* - Содержимое ноды

