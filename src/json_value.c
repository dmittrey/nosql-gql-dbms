#include "table.h"

#include "json/json_value.h"

#define ATTRIBUTE_ITEM_SIZE 24
#define VALUE_ITEM_SIZE 16

json_value_t *json_value_new()
{
    return my_malloc(json_value_t);
}

void json_value_ctor(json_value_t *json, json_value_type type, uint64_t attributes_count)
{
    json->object.attributes_count = attributes_count;
    json->object.attributes = my_malloc_array(kv *, attributes_count);
    json->type = type;
}

void json_value_dtor(json_value_t *json)
{
    for (size_t i = 0; i < json->object.attributes_count; i++)
    {
        free(json->object.attributes[i]);
        json_value_dtor(json->object.attributes[i]->value);
    }
    free(json->object.attributes);

    free(json);
}

sectoff_t json_value_get_item_size(json_value_t *json)
{
    return (json->object.attributes_count * ATTRIBUTE_ITEM_SIZE) + sizeof(json->type) + VALUE_ITEM_SIZE;
}

sectoff_t json_value_get_record_size(json_value_t *json)
{
    sectoff_t record_size = 0;

    for (size_t i = 0; i < json->object.attributes_count; i++)
    {
        record_size += string_get_size(json->object.attributes[i]->key);
    }
    if (json->type == TYPE_STRING)
    {
        record_size += string_get_size(json->value.string_val);
    }

    return record_size;
}